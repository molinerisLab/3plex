---
title: "R Notebook"
output:
  pdf_document: default
  html_notebook: default
---

```{r}
library(dplyr)
library(ggplot2)
library(scattermore)
library(pROC)

setwd("/home/epigen/TPXcCRE/dataset/v_test_randomiz_sub_h")
```



# Distribuzioni dei predittori utilizzati e ROC troncate
```{r}


df_3plex<-read.table("3plex.summary.clean.gz", header = T)
df_fasimLongtarget<-read.table("fasimLongtarget.summary.clean.gz", header = T)
df_triplexAligner<-read.table("triplexAligner.summary.clean.gz", header = T)

df_3plex$method="3plex"
df_fasimLongtarget$method="fasimLongtarget"
df_triplexAligner$method="triplexAligner"

df<-rbind(df_3plex,df_fasimLongtarget,df_triplexAligner)
ggplot(data=df, aes(x=pred2))+geom_histogram(bins = 100)+facet_wrap(~method, scales = "free_x")+scale_y_log10() 
```

Nel caso di 3plex e fasimLongtarget un elvato numero di 0 viene inserito, questi corrispondono ai casi o ai controlli che non producono alcun TPX predetto.

Questo probabilmente spiega perchÃ¨ le ROC per 3plex e fasimLongtarget risultano troncate.

# Average curves
```{r load_sens_sped}
df_3plex<-read.table("3plex.summary.clean.sens_spec.tsv", header = T)
df_fasimLongtarget<-read.table("fasimLongtarget.summary.clean.sens_spec.tsv", header = T)
df_triplexAligner<-read.table("triplexAligner.summary.clean.sens_spec.tsv", header = T)

df_3plex$method="3plex"
df_fasimLongtarget$method="fasimLongtarget"
df_triplexAligner$method="triplexAligner"

df<-rbind(df_3plex,df_fasimLongtarget,df_triplexAligner)
#df %>% mutate(spec_bin=ntile(specificities, n=10)) -> df
ggplot(data=df, aes(x=1-specificities, y=sensitivities))+geom_scattermore()+facet_wrap(~method)+theme_bw()
```

```{r}
df %>% mutate(spec_bin = cut(specificities, breaks=c(0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1), include.lowest=T)) -> df
#df %>% mutate(spec_bin = cut(specificities, breaks=c(0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1), include.lowest=T)) -> df # with this code include.lowest=T seems not working

df_avg <- df %>%
  group_by(spec_bin,method) %>%
  summarise(  mean_sens = mean(sensitivities)
            , mean_spec = mean(specificities)
            , ymin = mean(mean_sens) - sd(sensitivities)/2
            , ymax = mean(mean_sens) + sd(sensitivities)/2
            , ymin2 = min(sensitivities)
            , ymax2 = max(sensitivities)
            , median_sens = median(sensitivities)
            , ymin3 = quantile(sensitivities, probs = c(0.25))[1]
            , ymax3 = quantile(sensitivities, probs = c(0.75))[1])

p<-ggplot(df_avg) +
  scale_x_reverse() +
  geom_ribbon(aes(x = mean_spec, y = mean_sens, ymin = ymin2, ymax = ymax2, group=method), fill = "grey90") +
  geom_ribbon(aes(x = mean_spec, y = mean_sens, ymin = ymin, ymax = ymax, group=method), fill = "grey50") +
  geom_line(aes(x = mean_spec, y = mean_sens, color=method)) +
  theme_classic() +
  coord_fixed() +
  geom_segment(aes(x = 1, xend = 0, y = 0, yend = 1), color="darkgray", linetype="dashed", size = 0.3) +
  theme(plot.margin = margin(1,2,1,2, "cm"))

ggsave(filename = "methods_comparison_roc_avg.pdf", plot = p, device = "pdf")
p

```

Vedi anche versione della figura in pdf stand-alone in methods_comparison_roc_avg.pdf