---
title: "R Notebook"
output: html_notebook
---

```{r}
# Resources
library(ggplot2)
library(ggpubr)
library(dplyr)
library(pROC)
library(ggsci)

# working directory
setwd("/sto1/epigen/TPXcCRE/dataset")

# Dataframe
df <- read.table("tpx_paramspace_AUC.ALL_noSingleNt.method.Npeaks_version.noPROB_fitted.noT_pot_custom.technique.header_added.gz", header=T)

# Set params as factors and relevel 
groups_factors <- c("peak_method_all","ssRNA","singleStrandedness","min_len","error_rate","guanine_rate","repeat_filter","consecutive_error","predictor","technique")
df[,groups_factors] <- lapply(df[,groups_factors] , factor)
df$predictor <- relevel(df$predictor, ref = "t_pot_norm")
df$technique <- relevel(df$technique, ref = "ChIRP-seq")
df$min_len <- relevel(df$min_len, ref = "10")
df$singleStrandedness <- relevel(df$singleStrandedness, ref = "ss50")

# Remove "stability_norm_overcount"
df <- df[!grepl("Stability_norm_overcount", df$predictor),]
```



# Filtro il dataframe per avere solo i lncRNA con evidenze di triplex

```{r}
# Computational: Epr, DACOR1
# Experimental: TERC, NEAT1, HOTAIR, Meg3, MEG3, ANRIL, lncSmad7
# Speculated: Tug1

#triplex_evidence_ssRNA <- c("Eprn", "AC087482.1", "TERC", "NEAT1", "HOTAIR", "MEG3", "Meg3", "CDKN2B-AS1", "lncSmad7")
triplex_evidence_ssRNA <- c("TERC", "NEAT1", "HOTAIR", "MEG3", "Meg3", "CDKN2B-AS1", "lncSmad7")

df <- df %>% filter(ssRNA %in% triplex_evidence_ssRNA)
```


# Linear model excluding technique

```{r}
# groups to be investigated
groups <- colnames(df)[!colnames(df) %in% c("AUC","technique")]

# formula with all groups
formula_ssRNA <- as.formula(paste("AUC ~ ", paste(groups, collapse="+")))

# Linear model with all groups
model_ssRNA <- lm(formula_ssRNA, data = df)

print(formula_ssRNA)
summary(model_ssRNA)
```


# Linear model excluding ssRNA to determine technique coefficients

```{r}
# groups to be investigated
groups_techniques <- colnames(df)[!colnames(df) %in% c("AUC","ssRNA")]

# formula with all groups
formula_techniques <- as.formula(paste("AUC ~ ", paste(groups_techniques, collapse="+")))

# Linear model with all groups
model_techniques <- lm(formula_techniques, data = df)

print(formula_techniques)
summary(model_techniques)
```


# ANOVA ANALYSIS

# anova function 
```{r}
# considering ssRNA
anova_ssRNA <- anova(model_ssRNA)
print(anova_ssRNA)
print(summary(anova_ssRNA))

# considering technique
anova_techniques <- anova(model_techniques)
print(anova_techniques)
print(summary(anova_techniques))
```



```{r}
# considering ssRNA
#formula_pairwise <- as.formula("AUC ~ peak_method_all + technique + singleStrandedness + min_len + predictor")
aov_ssRNA <- aov(formula_ssRNA, data = df)
print(aov_ssRNA)
print(summary(aov_ssRNA))

# considering technique
aov_techniques <- aov(formula_techniques, data = df)
print(aov_techniques)
print(summary(aov_techniques))
```


# Compute empirical p-values

```{r}
# considering ssRNA
groups_ssRNA <- colnames(df)[!colnames(df) %in% c("AUC","technique")]

null_dist <- read.table("tpx_paramspace_AUC.ALL_noSingleNt.method.Npeaks_version.noPROB_fitted.noT_pot_custom.noOvercount.triplex_ssRNA.anova_exclude.gz"
                , header = F
                , col.names = c("param","pval"))

true_values <- read.table("tpx_paramspace_AUC.ALL_noSingleNt.method.Npeaks_version.noPROB_fitted.noT_pot_custom.noOvercount.triplex_ssRNA.header_added.true_prediction"
                          , header = F
                          , col.names = c("param","pval"))

null_dist_split <- split(x = null_dist, f = null_dist$param)

for (group in groups_ssRNA) {
  true_pval <- true_values[which(true_values$param == group),2]
  empirical_pval <- sum(null_dist_split[[group]][["pval"]] < true_pval)/10000
  print(group)
  print(empirical_pval)
}
```


```{r}
# considering technique
groups_techniques <- colnames(df)[!colnames(df) %in% c("AUC","ssRNA")]

null_dist <- read.table("tpx_paramspace_AUC.ALL_noSingleNt.method.Npeaks_version.noPROB_fitted.noT_pot_custom.noOvercount.technique.triplex_ssRNA.anova_exclude.gz"
                , header = F
                , col.names = c("param","pval"))

true_values <- read.table("tpx_paramspace_AUC.ALL_noSingleNt.method.Npeaks_version.noPROB_fitted.noT_pot_custom.noOvercount.technique.triplex_ssRNA.true_prediction"
                          , header = F
                          , col.names = c("param","pval"))

null_dist_split <- split(x = null_dist, f = null_dist$param)

for (group in groups_techniques) {
  true_pval <- true_values[which(true_values$param == group),2]
  empirical_pval <- sum(null_dist_split[[group]][["pval"]] < true_pval)/10000
  print(group)
  print(empirical_pval)
}
```


# ROC triplex ssRNA con best 

```{r}
z <- read.delim("best_single_params.ALL_ssRNA_scores.triplex_ssRNA.header_added.gz", header=T)

filter_table <- read.table("best_single_params.tsv", header=F)

z_split<-split(z,z$ssRNA)


### Select the best predictor for each ssRNA through filter file
z_split_predictors<-lapply(z_split,function(x){
  ssRNA_name<-levels(as.factor(x$ssRNA))
  predictor_name<-filter_table[which(filter_table[,2]==ssRNA_name), 10]
  z_split_filt<-x[,c("ssRNA","neg_pos",predictor_name)]
})

### Create roc objects with defined direction
roc_matrix<-lapply(z_split_predictors, function(x){
  ssRNA_name<-levels(as.factor(x$ssRNA))
  predictor_name<-filter_table[which(filter_table[,2]==ssRNA_name), 10]
  rocobj <- suppressMessages(roc(as.formula(paste(collapse = "~", c("neg_pos", predictor_name))), data= x, direction="<"))
  pROC::smooth(roc = rocobj, method = "binormal")
})

labels <- levels(as.factor(z$ssRNA))

for(i in seq_along(labels)){
  l<-labels[[i]]
  auc<-round(roc_matrix[[l]]$auc,3)
  labels[[i]]<-paste0(c(l,auc),collapse=" - ")
}

### ROC plot
p<-ggroc(roc_matrix) +
  theme_classic(base_size = 10) +
  geom_segment(aes(x = 1, xend = 0, y = 0, yend = 1), color="darkgray", linetype="dashed",size=0.3) +
  theme(plot.margin = margin(1,2,1,2, "cm")
        , plot.title = element_text(hjust = 0.5)
        , legend.title = element_blank()
        , legend.position = c(0.85, 0.3)
        , legend.key.size = unit(0.4, "cm"))+
  coord_fixed() +
  scale_color_igv(labels = labels)

print(p)

#ggsave(filename = "best_single_parameters.ROC_curves.triplex_ssRNA.smoothed.pdf", plot = p, device = "pdf")

```


TF_cell_line    fimo_score_AUC
CTCF_K562       0.892072215176772
E2F1_K562       0.796365904437853
GATA2_K562      0.713751222867691
IRF1_K562       0.773139122059681
MAX_K562        0.60504393244851
NFYA_K562       0.916754637747208
TAL1_K562       0.530138165289975
YY1_K562        0.716736982827242



```{r}
# create dataframe of ssRNA, specificity and sensitivity
avg_roc <- data.frame(ssRNA=character(),spec=double(),sens=double())
for(ssRNA in names(roc_matrix)){
  new_rows <- cbind(ssRNA=rep(ssRNA,length(roc_matrix[[ssRNA]][["specificities"]]))
                    , spec=round(roc_matrix[[ssRNA]][["specificities"]],digits = 2)
                    , sens=roc_matrix[[ssRNA]][["sensitivities"]])
  avg_roc <- rbind(avg_roc, new_rows)
}

# set spec and sens types
avg_roc[, 2:3] <- sapply(avg_roc[, 2:3], as.numeric)

# for each ssRNA and specificity value, select the average sensitivity
avg_roc <- avg_roc %>% group_by(ssRNA, spec) %>% summarise(mean_sens=mean(sens))

# for each specificity value, select the average, max and min sensitivity
avg_roc <- avg_roc %>%
  group_by(spec) %>%
  summarise(min_sens=min(mean_sens), max_sens=max(mean_sens), mean_sens=mean(mean_sens))

avg_roc$mean_sens[avg_roc$spec == 1] <- 0

# plot
p <- ggplot(avg_roc) +
    geom_line(aes(x = spec, y = mean_sens)) +
    scale_x_reverse() +
    geom_ribbon(aes(x = spec, y = mean_sens, ymin = min_sens, ymax = max_sens), fill = "grey70", alpha = 0.5) +
    theme_classic(base_size = 10) +
    coord_fixed() +
    geom_segment(aes(x = 1, xend = 0, y = 0, yend = 1), color="darkgray", linetype="dashed", size = 0.3) +
    theme(plot.margin = margin(1,2,1,2, "cm"))

print(p)

ggsave(filename = "average_triplex_ssRNA_ROC.smoothed.pdf", plot = p, device = "pdf")
```



# ROC triplex ssRNA con best general params

```{r}
# i picchi idr conservative ci sono solo per NEAT1 e lncSmad7

z <- read.table("tpx_paramspace_AUC.idr_conservative.best_general_params.triplex_ssRNA.header_added.gz"
              , header = T)

z_split<-split(z,z$ssRNA)

predictors <- c("Stability_best", "Stability_norm_overcount", "Stability_norm_undercount")

for (pred in predictors) {
  roc_matrix<-lapply(z_split, function(x){
    ssRNA_name<-levels(as.factor(x$ssRNA))
    predictor_name<-pred
    rocobj <- suppressMessages(roc(as.formula(paste(collapse = "~", c("neg_pos", predictor_name))), data= x, direction="<"))
    pROC::smooth(roc = rocobj, method = "binormal")
  })

  labels <- levels(as.factor(z$ssRNA))

  for(i in seq_along(labels)){
    l<-labels[[i]]
    auc<-round(roc_matrix[[l]]$auc,3)
    labels[[i]]<-paste0(c(l,auc),collapse=" - ")
  }
  
  p<-ggroc(roc_matrix) +
  theme_classic(base_size = 10) +
  geom_segment(aes(x = 1, xend = 0, y = 0, yend = 1), color="darkgray", linetype="dashed",size=0.3) +
  theme(plot.margin = margin(1,2,1,2, "cm")
        , plot.title = element_text(hjust = 0.5)
        , legend.title = element_blank()
        , legend.position = c(0.85, 0.3)
        , legend.key.size = unit(0.4, "cm"))+
  coord_fixed() +
  scale_color_igv(labels = labels)

  print(p)
}
                          
```




```{r}
z <- read.table("v8.10_TFBS/ALL_TFs.fimo_score.matrix.header_added.gz", header = T)

z_split<-split(z,z$Gene_ID)

roc_matrix<-lapply(z_split, function(x){
  Gene_ID_name<-levels(as.factor(x$Gene_ID))
  predictor_name<-"score"
  rocobj <- suppressMessages(roc(as.formula(paste(collapse = "~", c("neg_pos", predictor_name))), data= x, direction="<"))
  pROC::smooth(roc = rocobj, method = "binormal")
})

labels <- levels(as.factor(z$Gene_ID))

for(i in seq_along(labels)){
  l<-labels[[i]]
  auc<-round(roc_matrix[[l]]$auc,3)
  labels[[i]]<-paste0(c(l,auc),collapse=" - ")
  }
  
  p<-ggroc(roc_matrix) +
    theme_classic(base_size = 10) +
    geom_segment(aes(x = 1, xend = 0, y = 0, yend = 1), color="darkgray", linetype="dashed",size=0.3) +
    theme(plot.margin = margin(1,2,1,2, "cm")
          , plot.title = element_text(hjust = 0.5)
          , legend.title = element_blank()
          , legend.position = c(0.85, 0.3)
          , legend.key.size = unit(0.4, "cm"))+
    coord_fixed() +
    scale_color_igv(labels = labels)
  
  print(p)

ggsave(filename = "ALL_TFs.ROC_curves.smoothed.pdf", plot = p, device = "pdf")                       
```






```{r}
avg_roc <- read.delim("avg_roc_pre.tsv.avg1", header=T)

avg_roc2 <- avg_roc %>% group_by(ssRNA, spec_bin) %>% summarise(mean_spec = mean(spec_bin_avg), mean_sens = mean(sens)) 

avg_roc2 <- avg_roc2 %>%
  group_by(spec_bin) %>%
  summarise(mean_mean_sens = mean(mean_sens)
            , mean_spec = mean(mean_spec)
            , ymin = mean(mean_sens) - sd(mean_sens)/2
            , ymax = mean(mean_sens) + sd(mean_sens)/2
            , ymin2 = min(mean_sens)
            , ymax2 = max(mean_sens)
            , median_sens = median(mean_sens)
            , ymin3 = quantile(mean_sens, probs = c(0.25))[1]
            , ymax3 = quantile(mean_sens, probs = c(0.75))[1])

# aggiungere 0 e 1
avg_roc2 <- rbind(avg_roc2, c(0,1,0,1,1,1,1,1,1,1))
avg_roc2 <- rbind(avg_roc2, c(1,0,1,0,0,0,0,0,0,0))
	


# plot
p <- ggplot(avg_roc2) +
    scale_x_reverse() +
    geom_ribbon(aes(x = mean_spec, y = mean_mean_sens, ymin = ymin2, ymax = ymax2), fill = "grey70", alpha = 0.4) +
    #geom_ribbon(aes(x = mean_spec, y = mean_mean_sens, ymin = ymin3, ymax = ymax3), fill = "orange", alpha = 0.5) +
    geom_ribbon(aes(x = mean_spec, y = mean_mean_sens, ymin = ymin, ymax = ymax), fill = "grey70", alpha = 0.4) +
    geom_line(aes(x = mean_spec, y = mean_mean_sens)) +
    theme_classic(base_size = 10) +
    coord_fixed() +
    geom_segment(aes(x = 1, xend = 0, y = 0, yend = 1), color="darkgray", linetype="dashed", size = 0.3) +
    theme(plot.margin = margin(1,2,1,2, "cm"))

print(p)

ggsave(filename = "average_TFs_ROC.smoothed.pdf", plot = p, device = "pdf")
```




