---
title: "ANOVA Analysis"
output: html_notebook
---

```{r}
# Libraries
library(ggpubr)
library(dplyr)
library(pROC)
library(ggsci)
library(scales)

# Functions
plot_mean_distance <- function(aov_obj,factor_param, ordered = F) {
  tky <- as.data.frame(TukeyHSD(aov_obj, factor_param, ordered = ordered)[[factor_param]])
  tky$pair <- rownames(tky)
  tky <- tky[order(tky$diff),]
  print(tky)
  # Plot pairwise TukeyHSD comparisons and color by significance level
  p <- ggplot(tky, aes(color=cut(`p adj`, c(0, 0.01, 0.05, 1), label=c("p<0.01","p<0.05","Non-Sig")))) +
    geom_hline(yintercept=0, lty="11", colour="grey30") +
    geom_errorbar(aes(pair, ymin=lwr, ymax=upr), width=0.2) +
    geom_point(aes(pair, diff)) +
    labs(colour="") +
    #coord_flip() +
    theme_classic() +
    xlab("") + ylab("") +
    scale_color_manual(values = c("p<0.01" = "#a70000",
                                    "p<0.05" = "#ff7b7b",
                                    "Non-Sig" = "grey")) +
    theme(legend.position = "top", axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
  
  return(p)
}

# working directory
setwd("/sto1/epigen/TPXcCRE/dataset")
```

```
df <- read.table("tpx_paramspace_AUC.method.Npeaks_version.technique.header_added.gz", header=T)

# Set params as factors and relevel 
groups_factors <- c("peak_method_all","ssRNA","singleStrandedness","min_len","error_rate","guanine_rate","repeat_filter","consecutive_error","predictor","technique")
df[,groups_factors] <- lapply(df[,groups_factors] , factor)
df$predictor <- relevel(df$predictor, ref = "t_pot_norm")
df$technique <- relevel(df$technique, ref = "ChIRP-seq")
df$min_len <- relevel(df$min_len, ref = "10")
df$singleStrandedness <- relevel(df$singleStrandedness, ref = "ss50")

# Remove "stability_norm_overcount"
#df <- df[!grepl("Stability_norm_overcount", df$predictor),]
```


# Select only TPX-validated lncRNA
```{r}
# Computational: Epr, DACOR1
# Experimental: TERC, NEAT1, HOTAIR, Meg3, MEG3, ANRIL, lncSmad7
# Speculated: Tug1

triplex_evidence_ssRNA <- c("TERC", "NEAT1", "HOTAIR", "MEG3", "Meg3", "CDKN2B-AS1", "lncSmad7")

df <- df %>% filter(ssRNA %in% triplex_evidence_ssRNA)
```


# Linear model with default triplexator parameters
```{r}
df_min_len <- df %>% filter(singleStrandedness == "ss0"
                            , guanine_rate == 40
                            , error_rate == 20
                            , repeat_filter == "on"
                            , consecutive_error == 1
                            , predictor == "t_pot_norm")

groups_min_len <- c("peak_method_all", "ssRNA", "n_peaks", "min_len")

# formula
formula_min_len <- as.formula(paste("AUC ~ ", paste(groups_min_len, collapse="+")))

# Linear model with all groups
model_min_len <- lm(formula_min_len, data = df_min_len)

print(formula_min_len)
summary(model_min_len)
```


# Compute empirical p-values (ANOVA exclude, model min_len)
```{r}
null_dist <- read.table("tpx_paramspace_AUC.method.Npeaks_version.technique.triplex_ssRNA.triplexator_default_params.anova_exclude.gz"
                , header = F
                , col.names = c("param","pval"))

true_values <- read.table("tpx_paramspace_AUC.method.Npeaks_version.technique.triplex_ssRNA.triplexator_default_params.header_added.true_prediction"
                          , header = F
                          , col.names = c("param","pval"))

null_dist_split <- split(x = null_dist, f = null_dist$param)

for (group in names(null_dist_split)) {
  true_pval <- true_values[which(true_values$param == group),2]
  empirical_pval <- sum(null_dist_split[[group]][["pval"]] < true_pval)/10000
  print(group)
  print(empirical_pval)
}
```


# Plot pairwise comparison (model min_len)
```{r}
# https://stackoverflow.com/questions/33644034/how-to-visualize-pairwise-comparisons-with-ggplot2

aov_min_len <- aov(formula_min_len, data = df_min_len)
#print(aov_min_len)
#print(summary(aov_min_len))

pairwise_groups <- c("min_len")

for(group in pairwise_groups){
  print(group)
  print(plot_mean_distance(aov_min_len,group, ordered = F))
}
```


# Filtering out min len 12, 16 and TTS_covered_frac
```{r}
df <- df %>% filter(min_len != 12 & min_len != 16 & predictor != "TTS_covered_frac")
df$min_len <- droplevels(df$min_len)
df$predictor <- droplevels(df$predictor)

#df$min_len <- as.numeric(df$min_len)
#df$min_len <- as.factor(df$min_len)


# table(df$min_len)
# 10     8 
# 12960 12160 
```


# Linear model (technique excluded) 
```{r}
# groups to be investigated
groups <- colnames(df)[!colnames(df) %in% c("AUC","technique")]

# formula with all groups
formula_ssRNA <- as.formula(paste("AUC ~ ", paste(groups, collapse="+")))

# Linear model with all groups
model_ssRNA <- lm(formula_ssRNA, data = df)

print(formula_ssRNA)
summary(model_ssRNA)
```


# Linear model excluding ssRNA to determine technique coefficients
```{r}
# groups to be investigated
groups_techniques <- colnames(df)[!colnames(df) %in% c("AUC","ssRNA")]

# formula with all groups
formula_techniques <- as.formula(paste("AUC ~ ", paste(groups_techniques, collapse="+")))

# Linear model with all groups
model_techniques <- lm(formula_techniques, data = df)

print(formula_techniques)
summary(model_techniques)
```


# Compute empirical p-values (ANOVA exclude, model ssRNA)
```{r}
# considering ssRNA
groups_ssRNA <- colnames(df)[!colnames(df) %in% c("AUC","technique")]

null_dist <- read.table("tpx_paramspace_AUC.method.Npeaks_version.technique.triplex_ssRNA.len8_10.anova_exclude.ssRNA.gz"
                , header = F
                , col.names = c("param","pval"))

true_values <- read.table("tpx_paramspace_AUC.method.Npeaks_version.technique.triplex_ssRNA.len8_10.header_added.ssRNA.true_prediction"
                          , header = F
                          , col.names = c("param","pval"))

null_dist_split <- split(x = null_dist, f = null_dist$param)

for (group in groups_ssRNA) {
  true_pval <- true_values[which(true_values$param == group),2]
  empirical_pval <- sum(null_dist_split[[group]][["pval"]] < true_pval)/10000
  print(group)
  print(empirical_pval)
}
```


# Plot pairwise comparisons
```{r}
# https://stackoverflow.com/questions/33644034/how-to-visualize-pairwise-comparisons-with-ggplot2

aov_ssRNA <- aov(formula_ssRNA, data = df)
print(aov_ssRNA)
print(summary(aov_ssRNA))

pairwise_groups <- c("peak_method_all", "singleStrandedness", "min_len", "predictor", "error_rate", "guanine_rate")

for(group in pairwise_groups){
  print(group)
  print(plot_mean_distance(aov_ssRNA,group))
}
```


# Linear model (technique included) 
```{r}
# considering technique
groups_techniques <- colnames(df)[!colnames(df) %in% c("AUC","ssRNA")]

null_dist <- read.table("tpx_paramspace_AUC.method.Npeaks_version.technique.triplex_ssRNA.len8_10.anova_exclude.gz"
                , header = F
                , col.names = c("param","pval"))

true_values <- read.table("tpx_paramspace_AUC.method.Npeaks_version.technique.triplex_ssRNA.len8_10.header_added.true_prediction"
                          , header = F
                          , col.names = c("param","pval"))

null_dist_split <- split(x = null_dist, f = null_dist$param)

for (group in groups_techniques) {
  true_pval <- true_values[which(true_values$param == group),2]
  empirical_pval <- sum(null_dist_split[[group]][["pval"]] < true_pval)/10000
  print(group)
  print(empirical_pval)
}
```


# ROC triplex ssRNA (best parameter settings) 
```{r}
z <- read.delim("best_single_params.triplex_ssRNA_scores.header_added.gz", header=T)

filter_table <- read.table("best_single_params.triplex_ssRNA.tsv", header=F)

z_split<-split(z,z$ssRNA)

# Select the best predictor for each ssRNA through filter file
z_split_predictors<-lapply(z_split,function(x){
  ssRNA_name<-levels(as.factor(x$ssRNA))
  predictor_name<-filter_table[which(filter_table[,2]==ssRNA_name), 11]
  z_split_filt<-x[,c("ssRNA","neg_pos",predictor_name)]
})

# Create roc objects with defined direction
roc_matrix<-lapply(z_split_predictors, function(x){
  ssRNA_name<-levels(as.factor(x$ssRNA))
  predictor_name<-filter_table[which(filter_table[,2]==ssRNA_name), 11]
  rocobj <- suppressMessages(roc(as.formula(paste(collapse = "~", c("neg_pos", predictor_name))), data= x, direction="<"))
  #pROC::smooth(roc = rocobj, method = "binormal")
})

labels <- levels(as.factor(z$ssRNA))

for(i in seq_along(labels)){
  l<-labels[[i]]
  auc<-round(roc_matrix[[l]]$auc,3)
  labels[[i]]<-paste0(c(l,auc),collapse=" - ")
}

# ROC plot
p <- ggroc(roc_matrix) +
  theme_classic(base_size = 10) +
  geom_segment(aes(x = 1, xend = 0, y = 0, yend = 1), color="darkgray", linetype="dashed",size=0.3) +
  theme(plot.margin = margin(1,2,1,2, "cm")
        , plot.title = element_text(hjust = 0.5)
        , legend.title = element_blank()
        , legend.position = c(0.85, 0.3)
        , legend.key.size = unit(0.4, "cm"))+
  coord_fixed() +
  scale_color_nejm(labels = labels)

print(p)

ggsave(filename = "best_single_parameters.ROC_curves.triplex_ssRNA.pdf", plot = p, device = "pdf")
```


# ROC curves for triplex ssRNA (general parameter settings)
```{r}
z <- read.table("tpx_paramspace_AUC.idr_conservative.best_general_params.triplex_ssRNA.header_added.gz", header = T)

z_split<-split(z,z$ssRNA)

predictors <- c("Stability_best", "Stability_norm_overcount", "Stability_norm_undercount")

for (pred in predictors) {
  roc_matrix<-lapply(z_split, function(x){
    ssRNA_name<-levels(as.factor(x$ssRNA))
    predictor_name<-pred
    rocobj <- suppressMessages(roc(as.formula(paste(collapse = "~", c("neg_pos", predictor_name))), data= x, direction="<"))
    pROC::smooth(roc = rocobj, method = "binormal")
  })

  labels <- levels(as.factor(z$ssRNA))

  for(i in seq_along(labels)){
    l<-labels[[i]]
    auc<-round(roc_matrix[[l]]$auc,3)
    labels[[i]]<-paste0(c(l,auc),collapse=" - ")
  }
  
  p<-ggroc(roc_matrix) +
  theme_classic(base_size = 10) +
  geom_segment(aes(x = 1, xend = 0, y = 0, yend = 1), color="darkgray", linetype="dashed",size=0.3) +
  theme(plot.margin = margin(1,2,1,2, "cm")
        , plot.title = element_text(hjust = 0.5)
        , legend.title = element_blank()
        , legend.position = c(0.85, 0.3)
        , legend.key.size = unit(0.4, "cm"))+
  coord_fixed() +
  scale_color_igv(labels = labels)

  print(p)
}
                          
```


# TFs
```{r}
z <- read.table("v8.10_TFBS/ALL_TFs.fimo_score.matrix.header_added.gz", header = T)

z_split<-split(z,z$Gene_ID)

roc_matrix<-lapply(z_split, function(x){
  Gene_ID_name<-levels(as.factor(x$Gene_ID))
  predictor_name<-"score"
  rocobj <- suppressMessages(roc(as.formula(paste(collapse = "~", c("neg_pos", predictor_name))), data= x, direction="<"))
  pROC::smooth(roc = rocobj, method = "binormal")
})

labels <- levels(as.factor(z$Gene_ID))

for(i in seq_along(labels)){
  l<-labels[[i]]
  auc<-round(roc_matrix[[l]]$auc,3)
  labels[[i]]<-paste0(c(l,auc),collapse=" - ")
  }
  
  p<-ggroc(roc_matrix) +
    theme_classic(base_size = 10) +
    geom_segment(aes(x = 1, xend = 0, y = 0, yend = 1), color="darkgray", linetype="dashed",size=0.3) +
    theme(plot.margin = margin(1,2,1,2, "cm")
          , plot.title = element_text(hjust = 0.5)
          , legend.title = element_blank()
          , legend.position = c(0.85, 0.3)
          , legend.key.size = unit(0.4, "cm"))+
    coord_fixed() +
    scale_color_igv(labels = labels)
  
  print(p)

ggsave(filename = "ALL_TFs.ROC_curves.smoothed.pdf", plot = p, device = "pdf")                       
```


# TFs average ROC curve
```{r}
avg_roc <- read.delim("avg_roc_pre.tsv.avg1", header=T)

avg_roc2 <- avg_roc %>% group_by(ssRNA, spec_bin) %>% summarise(mean_spec = mean(spec_bin_avg), mean_sens = mean(sens)) 

avg_roc2 <- avg_roc2 %>%
  group_by(spec_bin) %>%
  summarise(mean_mean_sens = mean(mean_sens)
            , mean_spec = mean(mean_spec)
            , ymin = mean(mean_sens) - sd(mean_sens)/2
            , ymax = mean(mean_sens) + sd(mean_sens)/2
            , ymin2 = min(mean_sens)
            , ymax2 = max(mean_sens)
            , median_sens = median(mean_sens)
            , ymin3 = quantile(mean_sens, probs = c(0.25))[1]
            , ymax3 = quantile(mean_sens, probs = c(0.75))[1])

# add 0 and 1
avg_roc2 <- rbind(avg_roc2, c(0,1,0,1,1,1,1,1,1,1))
avg_roc2 <- rbind(avg_roc2, c(1,0,1,0,0,0,0,0,0,0))
	

p <- ggplot(avg_roc2) +
    scale_x_reverse() +
    geom_ribbon(aes(x = mean_spec, y = mean_mean_sens, ymin = ymin2, ymax = ymax2), fill = "grey70", alpha = 0.4) +
    #geom_ribbon(aes(x = mean_spec, y = mean_mean_sens, ymin = ymin3, ymax = ymax3), fill = "orange", alpha = 0.5) +
    geom_ribbon(aes(x = mean_spec, y = mean_mean_sens, ymin = ymin, ymax = ymax), fill = "grey70", alpha = 0.4) +
    geom_line(aes(x = mean_spec, y = mean_mean_sens)) +
    theme_classic(base_size = 10) +
    coord_fixed() +
    geom_segment(aes(x = 1, xend = 0, y = 0, yend = 1), color="darkgray", linetype="dashed", size = 0.3) +
    theme(plot.margin = margin(1,2,1,2, "cm"))

ggsave(filename = "average_TFs_ROC.smoothed.pdf", plot = p, device = "pdf")
```
